{% extends "layout.html" %}
{% block content %}
<h1 class="mb-4">Detecciones</h1>

<form class="card card-body shadow-sm mb-3" method="get">
  <div class="row g-2 align-items-end">
    <div class="col-12 col-md-3">
      <label class="form-label">Insecto</label>
      <select name="insecto" class="form-select">
        <option value="">(Todos)</option>
        {% for i in insectos %}
          <option value="{{ i }}" {% if filtros.insecto==i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label">Cámara</label>
      <select name="cam" class="form-select">
        <option value="">(Todas)</option>
        {% for c in cams %}
          <option value="{{ c }}" {% if filtros.cam==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Desde</label>
      <input type="date" name="desde" class="form-control" value="{{ filtros.desde }}">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Hasta</label>
      <input type="date" name="hasta" class="form-control" value="{{ filtros.hasta }}">
    </div>
    <div class="col-6 col-md-1 form-check mt-4">
      <input class="form-check-input" type="checkbox" id="solo" name="solo" value="1" {% if filtros.solo %}checked{% endif %}>
      <label class="form-check-label" for="solo">Sólo con insecto</label>
    </div>
    <div class="col-6 col-md-1">
      <button class="btn btn-primary w-100">Filtrar</button>
    </div>
  </div>
</form>

<div class="table-responsive shadow-sm">
  <table class="table align-middle mb-0">
    <thead class="table-light">
      <tr>
        <th>Fecha</th>
        <th>Cámara</th>
        <th>Insecto</th>
        <th>Archivo</th>
        <th>Imagen</th>
        <th>Telegram</th>
      </tr>
    </thead>
    <tbody>
      {% for d in items %}
      <tr>
        <td class="small">{{ d.fecha }}</td>
        <td class="small">{{ d.user.camera_name if d.user else "" }}</td>
        <td class="fw-semibold">{{ d.insecto_detectado }}</td>
        <td class="small">{{ d.nombre_archivo }}</td>
        <td style="width:110px">
          <a href="{{ url_for('imagen_by_id', det_id=d.id) }}" target="_blank">
            <img src="{{ url_for('imagen_by_id', det_id=d.id) }}" class="img-thumbnail" style="max-width:100px">
          </a>
        </td>
        <td>
          {% if d.enviado_telegram %}
            <span class="badge text-bg-success">Enviado</span>
          {% else %}
            <span class="badge text-bg-secondary">No</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% if not items %}
      <tr><td colspan="6" class="text-center text-muted py-4">Sin resultados</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% set last_page = (total // per_page) + (1 if (total % per_page) else 0) %}
<nav class="mt-3">
  <ul class="pagination justify-content-center">
    {% set q = request.args.to_dict() %}
    {% set q_prev = q.copy() %}
    {% set q_next = q.copy() %}
    {% set q_prev = q_prev.update({'page': page-1}) %}
    {% set q_next = q_next.update({'page': page+1}) %}
    <li class="page-item {% if page<=1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('detecciones', **request.args.to_dict(), page=page-1) }}">«</a>
    </li>
    <li class="page-item disabled"><span class="page-link">Página {{ page }} / {{ last_page if last_page else 1 }}</span></li>
    <li class="page-item {% if page>=last_page %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('detecciones', **request.args.to_dict(), page=page+1) }}">»</a>
    </li>
  </ul>
</nav>
{% endblock %}
